---
title: "Sta 440 Case 3"
author: "Sreya Gnanavel, Yura Heo, Lily Seelig"
date: "September 2025"
format: 
  pdf:
    documentclass: article
    fontsize: 11pt
geometry: margin=1in
execute: 
  warning: false
  message: false
  echo: false
---

```{r}
#| label: load_packages

library(tidyverse)
library(lubridate)
library(janitor)    
library(scales)  

```

```{r}
#| label: data

load("emsData.RData")



glimpse(x)
ems <- x


```

```{r}
ems <- ems %>%
  mutate(
    mins_dispatch_to_enroute = as.numeric(timeToEnroute, units = "mins"),
    mins_enroute_to_arrival  = as.numeric(observedTT, units = "mins"),
    mins_dispatch_to_arrival = as.numeric(difftime(DT.ARRIVE, DT.DISP, units = "mins")),
    mins_on_scene            = as.numeric(onSceneDur, units = "mins"),
    mins_to_hospital         = as.numeric(toHospitalTT, units = "mins"),
    mins_turnaround          = as.numeric(difftime(DT.AVAILABLE, DT.ARVREC, units = "mins")),
    
    call_date = as_date(DT.DISP),
    dow       = wday(DT.DISP, label = TRUE, abbr = TRUE),
    hour      = hour(DT.DISP)
  )


# sanity check
ems %>%
  summarise(across(starts_with("mins_"), 
                   list(min = ~min(.x, na.rm = TRUE),
                        max = ~max(.x, na.rm = TRUE))))

```

```{r}
#| label: add scenario

# pmin: minimum travel time across the stafed stations 

ems <- ems %>%
  mutate(
    # S0 (Current: 3 Central, 1 South)
    resp_S0 = pmin(eTT.BG.Ce, eTT.BG.So, na.rm = TRUE),

    # S1 (3 Central, 1 Near North)
    resp_S1 = pmin(eTT.BG.Ce, eTT.BG.NN, na.rm = TRUE),

    # S2 (3 Central, 1 Far North)
    resp_S2 = pmin(eTT.BG.Ce, eTT.BG.FN, na.rm = TRUE),

    # S3 (2 Central, 1 South, 1 Near North)
    resp_S3 = pmin(eTT.BG.Ce, eTT.BG.So, eTT.BG.NN, na.rm = TRUE),

    # S4 (2 Central, 1 South, 1 Far North)
    resp_S4 = pmin(eTT.BG.Ce, eTT.BG.So, eTT.BG.FN, na.rm = TRUE)
  )
```

```{r}
ems %>%
  select(eTT.BG.NN, eTT.BG.FN) %>%
  pivot_longer(cols = everything(), names_to = "Station", values_to = "Time") %>%
  mutate(Time = Time/60) %>%
  ggplot(aes(x = Time, fill = Station)) +
  geom_density(alpha=0.4) +
  labs(title="Estimated Travel Times: Near vs Far North (Best Guess)",
       x="Minutes", y="Density")
summary(ems$eTT.BG.NN/60)
summary(ems$eTT.BG.FN/60)

ems %>%
  mutate(current_central = eTT.BG.Ce/60,
         current_south = eTT.BG.So/60,
         near_north = eTT.BG.NN/60,
         far_north = eTT.BG.FN/60) %>%
  pivot_longer(cols = c(current_central, current_south, near_north, far_north),
               names_to = "Scenario", values_to = "Minutes") %>%
  ggplot(aes(x = Minutes, fill = Scenario)) +
  geom_density(alpha=0.4) +
  labs(title="Travel Time Distributions Under Different Allocations")
```
```{r}
ems %>%
  pivot_longer(starts_with("resp_S"), names_to = "scenario", values_to = "resp_time") %>%
  group_by(scenario) %>%
  summarise(
    mean = mean(resp_time, na.rm = TRUE),
    median = median(resp_time, na.rm = TRUE),
    p90 = quantile(resp_time, 0.9, na.rm = TRUE)
  )
```
```{r}
ems %>%
  pivot_longer(starts_with("resp_S"), names_to = "scenario", values_to = "resp_time") %>%
  ggplot(aes(resp_time, fill = scenario)) +
  geom_density(alpha = 0.4) +
  coord_cartesian(xlim = c(0, 2000)) +   # adjust limit if needed
  labs(title = "Response time distributions across scenarios",
       x = "Estimated response time (seconds)", y = "Density")
```
```{r}
ems %>%
  pivot_longer(starts_with("resp_S"), names_to = "scenario", values_to = "resp_time") %>%
  ggplot(aes(scenario, resp_time, fill = scenario)) +
  geom_boxplot(outlier.shape = NA) +
  coord_cartesian(ylim = c(0, 2000)) +
  labs(title = "Response time by scenario",
       x = "Scenario", y = "Estimated response time (seconds)") +
  theme(legend.position = "none")
```

